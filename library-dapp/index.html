<!DOCTYPE html>
<html>
<head>
  <title>Library Management System Group07</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.3.0/dist/web3.min.js"></script>
  <style>
    .book-list { list-style-type: none; padding: 0; }
    .book-item { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>Library System</h1>
  <button onclick="connectWallet()">Connect Wallet</button>
  <button onclick="disconnectWallet()">Disconnect Wallet</button>
  <div id="account"></div>
  <h2>Add Book</h2>
  <input type="text" id="title" placeholder="Title">
  <input type="text" id="author" placeholder="Author">
  <input type="number" id="price" placeholder="Price">
  <button onclick="addBook()">Add Book</button>
  <h2>Books</h2>
  <ul id="bookList" class="book-list"></ul>
  <script>
    let web3;
    let librarySystem;
    const contractAddress = '0xcC749039B78eE3031cb5Ec139c558aa2AecFc30c'; // Replace with your contract address

    const abi = [
      {
        "constant": false,
        "inputs": [
          { "name": "_title", "type": "string" },
          { "name": "_author", "type": "string" },
          { "name": "_price", "type": "uint256" }
        ],
        "name": "addBook",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "constant": false,
        "inputs": [
          { "name": "_id", "type": "uint256" }
        ],
        "name": "borrowBook",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "constant": false,
        "inputs": [
          { "name": "_id", "type": "uint256" }
        ],
        "name": "buyBook",
        "outputs": [],
        "payable": true,
        "stateMutability": "payable",
        "type": "function"
      },
      {
        "constant": true,
        "inputs": [],
        "name": "getBooks",
        "outputs": [
          {
            "components": [
              { "name": "id", "type": "uint256" },
              { "name": "title", "type": "string" },
              { "name": "author", "type": "string" },
              { "name": "price", "type": "uint256" },
              { "name": "borrower", "type": "address" },
              { "name": "isAvailable", "type": "bool" }
            ],
            "name": "",
            "type": "tuple[]"
          }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
      }
    ];

    async function connectWallet() {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        await window.ethereum.enable();
        const accounts = await web3.eth.getAccounts();
        document.getElementById('account').innerText = "Connected account: " + accounts[0];
        librarySystem = new web3.eth.Contract(abi, contractAddress);
        loadBooks();
      } else {
        alert('MetaMask not detected');
      }
    }

    function disconnectWallet() {
      if (window.ethereum && web3) {
        web3 = null;
        librarySystem = null;
        document.getElementById('account').innerText = "Disconnected";
        alert('Wallet disconnected');
      } else {
        alert('MetaMask not detected');
      }
    }

    async function addBook() {
      const title = document.getElementById('title').value;
      const author = document.getElementById('author').value;
      const price = document.getElementById('price').value;
      const accounts = await web3.eth.getAccounts();
      console.log('Adding book with details:', { title, author, price, account: accounts[0] });
      try {
        const result = await librarySystem.methods.addBook(title, author, price).send({ from: accounts[0] });
        console.log('Transaction successful:', result);
        loadBooks();
      } catch (error) {
        console.error('Error adding book:', error);
      }
    }

    async function loadBooks() {
      try {
        const books = await librarySystem.methods.getBooks().call();
        const bookList = document.getElementById('bookList');
        bookList.innerHTML = '';
        books.forEach(book => {
          const bookItem = document.createElement('li');
          bookItem.className = 'book-item';
          bookItem.innerHTML = `
            <strong>${book.title}</strong> by ${book.author} - ${web3.utils.fromWei(book.price, 'ether')} ETH
            <br />
            ${book.isAvailable ? `<button onclick="borrowBook(${book.id})">Borrow</button>
            <button onclick="buyBook(${book.id}, ${book.price})">Buy</button>` : 'Not available'}
          `;
          bookList.appendChild(bookItem);
        });
      } catch (error) {
        console.error('Error loading books:', error);
      }
    }

    async function borrowBook(id) {
      const accounts = await web3.eth.getAccounts();
      try {
        const result = await librarySystem.methods.borrowBook(id).send({ from: accounts[0] });
        console.log('Transaction successful:', result);
        loadBooks();
      } catch (error) {
        console.error('Error borrowing book:', error);
      }
    }

    async function buyBook(id, price) {
      const accounts = await web3.eth.getAccounts();
      try {
        const result = await librarySystem.methods.buyBook(id).send({ from: accounts[0], value: price });
        console.log('Transaction successful:', result);
        loadBooks();
      } catch (error) {
        console.error('Error buying book:', error);
      }
    }
  </script>
</body>
</html>
